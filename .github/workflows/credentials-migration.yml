name: Credentials Migration Test

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ fix/security/credentials-storage ]

jobs:
  credentials-migration:
    name: Credentials Migration on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Verify Node and NPM versions
        run: node -v && npm -v

      - name: Diagnose keytar install (diagnostic only)
        shell: pwsh
        run: |
          Write-Host "Node version:`n"; node -v; npm -v
          Write-Host "Attempt to install keytar (diagnostic):"
          try { npm i keytar --no-audit --no-fund -ErrorAction Stop } catch { Write-Host "npm i keytar failed (diagnostic)" }
          Write-Host "node_modules/keytar exists:"; if(Test-Path node_modules\keytar){ Write-Host 'yes' } else { Write-Host 'no' }
          try { node -e "require('keytar'); console.log('require(keytar) ok')" } catch { Write-Host 'require(keytar) failed' }

      - name: Run credentials migration test (real Keytar)
        run: npm run test:credentials
        env:
          CI: true

      - name: Run credentials migration mock test (no native deps)
        run: npm run test:credentials:mock
        env:
          CI: true

      - name: Run APICredentialsService mock tests
        run: npm run test:credentials:service-mock
        env:
          CI: true
